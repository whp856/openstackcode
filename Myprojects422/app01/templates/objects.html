<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>objects</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/objects.css' %}" />
</head>

<body>

    <div id="main">
        <h1><img src="{% static 'images/doc.jpg' %}" class="header-image" /></h1>
        <hr class="divider">
        <h1 class="container-name">å½“å‰å®¹å™¨{{data2}}</h1>

        <!-- ä¿®æ”¹è¿”å›æŒ‰é’® -->
        <div class="return-container">
            <a href="/containers"><button class="butt return-btn">è¿”å›ä¸Šçº§é¡µé¢</button></a>
        </div>

        <!-- æœç´¢å’Œæ’åºåŠŸèƒ½ -->
        <div class="search-sort-container">
            <div class="search-container">
                <form method="get" class="search-form">
                    <input type="text" name="search" placeholder="æœç´¢æ–‡ä»¶å..." value="{{search_query|default:''}}"
                        class="search-input">
                    <button type="submit" class="butt">æœç´¢</button>
                    {% if search_query %}
                    <a href="?search=" class="butt">æ¸…é™¤</a>
                    {% endif %}
                </form>
            </div>


            <div class="sort-container">
                <label class="sort-label">æ’åºï¼š</label>
                <select name="sort" onchange="window.location.href='?search={{search_query}}&sort='+this.value"
                    class="sort-select">
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>åç§°</option>
                    <option value="date" {% if sort_by == 'date' %}selected{% endif %}>æ—¥æœŸ</option>
                    <option value="size" {% if sort_by == 'size' %}selected{% endif %}>å¤§å°</option>
                </select>
            </div>
        </div>

        <table class="file-table">
            <thead>
                <tr>
                    <th>åç§°</th>
                    <th>æ—¥æœŸ</th>
                    <th>ç±»å‹</th>
                    <th>æ–‡ä»¶å¤§å°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for key in resp1 %}
                <tr>
                    <td>{{key.name}}</td>
                    <td>{{key.last_modified}}</td>
                    <td data-type="{{key.content_type}}">{{key.content_type}}</td>
                    <td>{{key.bytes}} å­—èŠ‚</td>
                    <td>
                        <input class="butt1 action-btn view-btn" type="button" value="æŸ¥çœ‹"
                            data-url="/view_file/{{data2}}/{{key.name}}/{{key.content_type}}">
                        <input class="butt1 action-btn delete-btn" type="button" value="åˆ é™¤"
                            data-url="/delete/{{data2}}/{{key.name}}" />
                        <input class="butt1 action-btn download-btn" type="button" value="ä¸‹è½½"
                            data-url="/download/{{data2}}/{{key.name}}" />
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if not resp1 %}
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div class="empty-state">
            <h3>ğŸ“ å½“å‰å®¹å™¨ä¸ºç©º</h3>
            <p>è¯·ä½¿ç”¨ä¸‹æ–¹ä¸Šä¼ åŠŸèƒ½æ·»åŠ æ–‡ä»¶</p>
        </div>
        {% else %}
        <!-- åˆ†é¡µå¯¼èˆª -->
        <div class="pagination">
            {% if resp1.has_previous %}
            <a href="?search={{search_query}}&sort={{sort_by}}&page=1">|&lt;ç¬¬ä¸€é¡µ</a>
            <a href="?search={{search_query}}&sort={{sort_by}}&page={{ resp1.previous_page_number }}">å‰ä¸€é¡µ</a>
            {% endif %}
            ç¬¬ {{resp1.number}} é¡µï¼Œå…± {{resp1.paginator.num_pages}} é¡µ
            {% if resp1.has_next %}
            <a href="?search={{search_query}}&sort={{sort_by}}&page={{resp1.next_page_number}}">ä¸‹ä¸€é¡µ</a>
            <a href="?search={{search_query}}&sort={{sort_by}}&page={{resp1.paginator.num_pages}}">æœ€æœ«é¡µ&gt;|</a>
            {% endif %}
        </div>
        {% endif %}
        </form>

        <!-- ä¸Šä¼ è¡¨å• -->
        <div class="upload-form">
            <form method="post" action="/upload/{{data2}}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="upload-container">
                    <input type="file" name="filename" accept="image/*,.txt,.doc,.docx,.pdf" class="file-input">
                    <button type="submit" class="upload-btn">ä¸Šä¼ æ–‡ä»¶</button>
                </div>
            </form>
        </div>

    </div>

    <script>
        // æ“ä½œæŒ‰é’®äº‹ä»¶å¤„ç† - ä½¿ç”¨data-urlå±æ€§
        document.querySelectorAll('.action-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                const url = this.getAttribute('data-url');
                if (!url) return;

                const fileName = this.closest('tr').querySelector('td:nth-child(1)').textContent;

                if (this.classList.contains('delete-btn')) {
                    // åˆ é™¤æŒ‰é’®éœ€è¦ç¡®è®¤
                    if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${fileName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                        window.location.href = url;
                    }
                } else if (this.classList.contains('view-btn')) {
                    // æŸ¥çœ‹æŒ‰é’®ç›´æ¥è·³è½¬
                    window.location.href = url;
                } else if (this.classList.contains('download-btn')) {
                    // ä¸‹è½½æŒ‰é’®ç›´æ¥è·³è½¬
                    window.location.href = url;
                }
            });
        });

        // æ–‡ä»¶ä¸Šä¼ æˆåŠŸåçš„æç¤º
        window.addEventListener('load', function () {
            // å¦‚æœURLä¸­æœ‰ä¸Šä¼ æˆåŠŸçš„å‚æ•°ï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            if (window.location.search.includes('upload=success')) {
                const message = document.createElement('div');
                message.style.cssText = 'background-color: #4CAF50; color: white; text-align: center; padding: 10px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;';
                message.textContent = 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼';
                document.body.appendChild(message);

                // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
                setTimeout(() => {
                    message.remove();
                    // æ¸…é™¤URLå‚æ•°
                    const url = new URL(window.location);
                    url.searchParams.delete('upload');
                    window.history.replaceState({}, '', url);
                }, 3000);
            }
        });

        // æœç´¢æ¡†å®æ—¶æœç´¢åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶æœç´¢åŠŸèƒ½
                    // å½“å‰ä¿æŒåŸæœ‰æäº¤æ–¹å¼
                }, 500);
            });
        }


        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
        document.querySelectorAll('.file-table tbody tr td:nth-child(5)').forEach(cell => {
            const size = parseInt(cell.textContent);
            if (!isNaN(size)) {
                cell.textContent = formatFileSize(size);
            }
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function (e) {
            // Ctrl+F èšç„¦æœç´¢æ¡†
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                const searchInput = document.querySelector('.search-input');
                if (searchInput) {
                    searchInput.focus();
                }
            }
        });
    </script>
</body>

</html>